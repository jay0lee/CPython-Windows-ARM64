# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x86, x64, arm, arm64]
        majorpython: [3.9, 3.10]

    steps:
      - name: Set environment variables
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          switch ( $ARCH )
          {
            x86
              {
                $installer_arch = 'Win32'
                $embedded_arch = ''
              }
            x64
              {
                $installer_arch = 'AMD64'
                $embedded_arch = 'ADM64'
              }
            arm
              {
                $installer_arch = 'ARM'
                $embedded_arch = 'ARM'
              }
            arm64
              {
                $installer_arch = 'ARM64'
                $embedded_arch = 'ARM64'
              }
          }  
          Write-Host "ARCH=${ARCH}" >> $GITHUB_ENV
          Write-Host "installer_arch=${installer_arch}" >> $GITHUB_ENV
          Write-Host "embedded_arch=${embedded_arch}" >> $GITHUB_ENV

      - name: Install 7Zip PowerShell Module
        run: Install-Module 7Zip4PowerShell -Force -Verbose

      - name: Clone Python
        env:
          majorpython: ${{ matrix.majorpython }}
        run: |
          git clone https://github.com/jay0lee/cpython.git
          cd cpython
          git checkout $majorpython

      - name: Build installers
        run: |
          cd cpython
          Tools\msi\buildrelease.bat -$ARCH --out release
          echo "In release:"
          dir release\
          dir release\*\

      - name: upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: python-${{ env.installer_arch }}.exe
          path: |
            cpython/release/${{ env.installer_arch }}.exe
